{
  "name": "miniPHP",
  "tagline": "A small, simple PHP MVC framework skeleton that encapsulates a lot of features surrounded with powerful security layers.",
  "body": "![miniPHP](https://raw.githubusercontent.com/OmarElGabry/miniPHP/master/public/img/backgrounds/background.png)\r\n\r\n# miniPHP\r\n[![Build Status](https://scrutinizer-ci.com/g/OmarElGabry/miniPHP/badges/build.png?b=master)](https://scrutinizer-ci.com/g/OmarElGabry/miniPHP/build-status/master)\r\n[![Scrutinizer Code Quality](https://scrutinizer-ci.com/g/OmarElGabry/miniPHP/badges/quality-score.png?b=master)](https://scrutinizer-ci.com/g/OmarElGabry/miniPHP/?branch=master)\r\n[![Code Climate](https://codeclimate.com/github/OmarElGabry/miniPHP/badges/gpa.svg)](https://codeclimate.com/github/OmarElGabry/miniPHP)\r\n[![Dependency Status](https://www.versioneye.com/user/projects/55ae85dd3865620018000001/badge.svg?style=flat)](https://www.versioneye.com/user/projects/55ae85dd3865620018000001)\r\n\r\n[![Latest Stable Version](https://poser.pugx.org/omarelgabry/miniphp/v/stable)](https://packagist.org/packages/omarelgabry/miniphp)\r\n[![License](https://poser.pugx.org/omarelgabry/miniphp/license)](https://packagist.org/packages/omarelgabry/miniphp)\r\n\r\nA small, simple PHP MVC framework skeleton that encapsulates a lot of features surrounded with powerful security layers.\r\n\r\nminiPHP is a very simple application, useful for small projects, helps to understand the PHP MVC skeleton, know how to authenticate and authorize, encrypt data and apply security concepts, sanitization and validation, make ajax calls and more.\r\n\r\nIt's not a full framework, nor a very basic one but it's not complicated. You can easily install, understand, and use it in any of your projects.\r\n\r\nIt's indented to remove the complexity of the frameworks. Things like routing, authentication, authorization, manage user session and cookies, and so on are not something I've invented from the scratch, however, they are aggregation of concepts already implemented in other frameworks, but, built in a much simpler way, So, you can understand it, and take it further.\r\n\r\nIf you need to build bigger application, and take the advantage of most of the features available in frameworks, you can see [CakePHP](http://cakephp.org/), [Laravel](http://laravel.com/), [Symphony](http://symfony.com/).\r\n\r\nEither way, It's important to understand the PHP MVC skeleton, and know how to authenticate and authorize, learn about security issues and how can you defeat against, and how to build you own application using the framework.\r\n\r\n## Index\r\n+ [Demo](#live-demo)\r\n+ [Installation](#installation)\r\n+ [Routing](#routing)\r\n+ [Controller](#controller)\r\n+ [Components(Middlewares)](#components)\r\n\t+ [Authentication](#authentication)\r\n\t    - [Session](#session)\r\n\t    - [Cookies](#cookies)\r\n\t+ [Authorization](#authorization)\r\n\t+ [Security](#security)\r\n\t\t- [HTTP Methods](#http-method)\r\n\t\t- [Domain Validation](#referer)\r\n\t\t- [Form Tampering](#form-tampering)\r\n\t\t- [CSRF](#csrf)\r\n\t\t- [htaccess](#htaccess)\r\n\t+ [Turn on/off Components](#turn-on-off-components)\r\n+ [Views](#views)\r\n+ [Models](#models)\r\n+ [Login](#login)\r\n\t- [User Verification](#user-verification)\r\n\t- [Forgotten Password](#forgotten-password)\r\n\t- [Brute-Force attack](#brute-force)\r\n\t- [Captcha](#captcha)\r\n\t- [Block IP Addresses](#block-ip)\r\n+ [Database](#database)\r\n+ [Encryption](#encryption)\r\n+ [Validation](#validation)\r\n+ [Errors & Exceptions](#errors-exceptions)\r\n+ [Logger](#logger)\r\n+ [Email](#email)\r\n+ [Configurations](#configurations)\r\n+ [JavaScript & Ajax](#js)\r\n+ [Application(Demo)](#app-demo)\r\n\t+ [Intro](#intro-demo)\r\n\t+ [Installation](#installation-demo)\r\n\t+ [User Profile](#profile)\r\n\t+ [Files](#files)\r\n\t+ [News Feed & Posts & Comments](#newsfeed-posts-comments)\r\n\t+ [Admin](#admin)\r\n\t+ [Notifications](#notifications)\r\n\t+ [Report Bugs](#bugs)\r\n\t+ [Backups](#backups)\r\n+ [ToDo Application(Step By Step Implementation)](#todo)\r\n+ [Support](#support)\r\n+ [Contribute](#contribute)\r\n+ [Dependencies](#dependencies)\r\n+ [License](#license)\r\n\r\n## Demo <a name=\"live-demo\"></a>\r\nA live demo is available [here](https://miniphp.ga/). The live demo is for the demo application built on top of this framework in this [section](#app-demo). Thanks to [@Everterstraat](https://github.com/Everterstraat).\r\n\r\n> Some features mighn't work in the demo.\r\n\r\n## Installation <a name=\"installation\"></a>\r\nInstall via [Composer](https://getcomposer.org/doc/00-intro.md)\r\n\r\n```\r\n\tcomposer install\r\n```\r\n\r\n## Routing <a name=\"routing\"></a>\r\n\r\nWhenever you make a request to the application, it wil be directed to _index.php_ inside public folder. \r\nSo, if you make a request: ```http://localhost/miniPHP/User/update/412 ```. This will be splitted and translated into \r\n\r\n+ Controller: User\r\n+ Action Method: update\r\n+ Arguemtns to action method: 412\r\n\r\nIn fact, htaccess splits everything comes after ```http://localhost/miniPHP ``` and adds it to the URL as querystring argument. So, this request will be converted to: ```http://localhost/miniPHP?url='User/update/412' ```.\r\n\r\nThen ```App``` Class, Inside ```splitUrl()```, will split the query string ```$_GET['url']``` into controller, action method, and any passed arguments to action method.\r\n\r\nIn ```App``` Class, Inside ```run()```, it will instantiate an object from controller class, and make a call to action method, passing any arguments if exist.\r\n\r\n## Controller <a name=\"controller\"></a>\r\n\r\nAfter the ```App``` Class intantiates controller object, It will call ```$this->controller->startupProcess()``` method, which in turn will trigger 3 consecutive events/methods:\r\n\r\n1. ```initialize()```: Use it to load components\r\n2. ```beforeAction()```: Perform any logic actions before calling controller's action method\r\n3. ```triggerComponents()```: Trigger startup() method of loaded components\r\n\r\nThe constructor of ```Controller``` Class **shouldn't** be overridden, instead you can override the ```initialize()``` & ```beforeAction()``` methods in the extending classes.\r\n\r\nAfter the startup process of the constrcutor finishes it's job, Then, the requested action method will be called, and arguments will be passed(if any).\r\n\r\n## Components(Middlewares) <a name=\"components\"></a>\r\nComponents are the middlewares. They provide reusable logic to be used as part of the controller. Authentication, Authorization, Form Tampering, and Validate CSRF Tokens are implemented inside Components. \r\n\r\nIt's better to pull these pieces of logic out of controller class, and keep all various tasks and validations inside these Components.\r\n\r\nEvery component inherits from the base/super class called ```Component```. Each has a defined task. There are two components, one for called _Auth_ for Authentication and Authorization, and the other one called _Security_ for other Security Issues.\r\n\r\nThey are very simple to deal with, and they will be called inside controller constructor.\r\n\r\n### Authentication <a name=\"authentication\"></a>\r\nIs user has right credentials?\r\n\r\n#### Session<a name=\"session\"></a>\r\nThe AuthComponent takes care of user session.\r\n\r\n+ Prevent Session Concurrency\r\n\t- There can't be 2 users logged in with same user credentials.\r\n+ Defeat against Session Hijacking & Fixation\r\n\t- HTTP Only with session cookies\r\n\t- Whenever it's possible, It's Highly Recommended to use Secured connection(SSL).\r\n\t- Regenerate session periodically and after actions like login, forgot password, ...etc.\r\n\t- Validate user's IP Address and User agent(initially will be stored in session). Although they can be faked, It's better to keep them as part of validation methods.\r\n+ Session Expiration\r\n\t- Session will expire after certain duration(>= 1 day)\r\n\t- Session cookie in browser is also configured to be expired after (>= 1 week)\r\n+ Session accessible only through the HTTP protocol\r\n\t- This is important so sessions won't be accessible by JS.\r\n\r\n#### Cookies<a name=\"cookies\"></a>\r\n\r\n+ Remember Me Tokens\r\n\t- User can keep himself logged in using cookies\r\n\t- HTTP Only with cookies\r\n\t- Whenever it's possible, It's Highly Recommended to use Secured connection(SSL).\r\n\t- Cookies stored in browser are attached with tokens and Encrypted data\r\n\t- Cookies in browser are also configured to be expired after (>= 2 weeks)\r\n\t\r\n### Authorization <a name=\"authorization\"></a>\r\nDo you have the right to access or to perform X action?. The _Auth_ Component takes care of authorization for each controller. Thus, each controller should implement ``` isAuthorized() ``` method. What you need to do is to return ``` boolean ``` value.\r\n\r\nSo, for example, in order to check if current user is admin or not, you would do something like this:\r\n```php\r\n    // AdminController\r\n\r\n    public function isAuthorized(){\r\n\r\n        $role = Session::getUserRole();\r\n        if(isset($role) && $role === \"admin\"){\r\n            return true;\r\n        }\r\n        return false;\r\n    }\r\n\r\n```\r\n\r\nIf you want to take it further and apply some permission rules, There is a powerful class called ``` Permission ``` responsible for defining permission rules. This class allows you to define \"Who is allowed to perform specific action method on current controller\".\r\n\r\nSo, for example, in order to allow admins to perform any action on notes, while normal users can only edit their notes:\r\n```php\r\n   // NotesController\r\n   \r\n   public function isAuthorized(){\r\n\r\n        $action = $this->request->param('action');\r\n        $role \t= Session::getUserRole();\r\n        $resource = \"notes\";\r\n\r\n\t\t// only for admins\r\n\t\t// they are allowed to perform all actions on $resource\r\n        Permission::allow('admin', $resource, ['*']);\r\n\r\n\t\t// for normal users, they can edit only if the current user is the owner\r\n\t\tPermission::allow('user', $resource, ['edit'], 'owner');\r\n\r\n        $noteId = $this->request->data(\"note_id\");\r\n        $config = [\r\n            \"user_id\" => Session::getUserId(),\r\n            \"table\" => \"notes\",\r\n            \"id\" => $noteId\r\n        ];\r\n\r\n\t\t// providing the current user's role, $resource, action method, and some configuration data\r\n\t\t// Permission class will check based on rules defined above and return boolean value\r\n\t\treturn Permission::check($role, $resource, $action, $config);\r\n    }\r\n```\r\nNow, you can check authorization based on user's role, resource, and for each action method.\r\n\r\n### Security <a name=\"security\"></a>\r\nThe SecurityComponent takes care of various security tasks and validation. \r\n\r\n#### HTTP Method<a name=\"http-method\"></a>\r\n\r\nIt's important to restrict the request methods. As an example, if you have an action method that accepts form values, So, ONLY POST request will be accepted. The same idea for Ajax, GET, ..etc. You can do this inside ```beforeAction() ``` method. \r\n\r\n```php\r\n    // NotesController\r\n\r\n    public function beforeAction(){\r\n\r\n        parent::beforeAction();\r\n\r\n        $actions = ['create', 'delete'];\r\n\r\n        $this->Security->requireAjax($actions);\r\n        $this->Security->requirePost($actions);\r\n    }\r\n```\r\n\r\nAlso if you require all requests to be through secured connection, you can configure the whole controller, or specific actions to redirect all requests to HTTPS instead of HTTP.\r\n\r\n```php\r\n    // NotesController\r\n\r\n    public function beforeAction(){\r\n\r\n        parent::beforeAction();\r\n\r\n        $actions = ['create', 'delete'];\t// specific action methods\t\r\n        $actions = ['*'];\t\t        \t// all action methods\r\n\r\n        $this->Security->requireSecure($actions);\r\n    }\r\n```\r\n#### Domain Validation<a name=\"referer\"></a>\r\n\r\nIt checks & validates if request is coming from the same domain. Although they can be faked, It's good to keep them as part of our security layers.\r\n\r\n#### Form Tampering<a name=\"form-tampering\"></a>\r\n\r\nValidate submitted form coming from POST request. The pitfall of this method is you need to define the expected form fields, or data that will be sent with POST request. \r\n\r\nBy default, the framework will validate for form tampering when POST request is made, and it will make sure the CSRF token is passed with the form fields. In this situation, if you didn't pass the CSRF token, it will be considered as a Security thread.\r\n\r\n+ Unknown fields cannot be added to the form.\r\n+ Fields cannot be removed from the form.\r\n\r\n```php\r\n    // NotesController\r\n\r\n    public function beforeAction(){\r\n\r\n        parent::beforeAction();\r\n\r\n        $action = $this->request->param('action');\r\n        $actions = ['create', 'delete'];\r\n\r\n        $this->Security->requireAjax($actions);\r\n        $this->Security->requirePost($actions);\r\n\r\n        switch($action){\r\n            case \"create\":\r\n                $this->Security->config(\"form\", [ 'fields' => ['note_text']]);\r\n                break;\r\n            case \"delete\":\r\n            \t// If you want to disable validation for form tampering\r\n            \t// $this->Security->config(\"validateForm\", false);\r\n                $this->Security->config(\"form\", [ 'fields' => ['note_id']]);\r\n                break;\r\n        }\r\n    }\r\n```\r\n\r\n#### CSRF Tokens<a name=\"csrf\"></a>\r\nCSRF Tokens are important to validate the submitted forms, and to make sure they aren't faked. A hacker can trick the user to make a request to a website, or click on a link, and so on.\r\n\r\nThey are valid for a certain duration(>= 1 day), then it will be regenerated and stored in user's session.\r\n\r\nCSRF validation is disabled by default. If you want to validate the CSRF token, then assign ```validateCsrfToken``` to ```true``` as shown in the example below. CSRF validation will be forced when request is POST and form tampering is enabled. \r\n\r\nNow, You do not need to manually verify the CSRF token on every requests. The _Security_ Component will verify token in the request versus the token stored in the session.\r\n\r\n```php\r\n    // NotesController\r\n\r\n    public function beforeAction(){\r\n\r\n        parent::beforeAction();\r\n\r\n\t\t$action = $this->request->param('action');\r\n\t\t$actions = ['index'];\r\n\r\n        $this->Security->requireGet($actions);\r\n\r\n        switch($action){\r\n            case \"index\":\r\n                $this->Security->config(\"validateCsrfToken\", true);\r\n                break;\r\n        }\r\n    }\r\n```\r\n\r\nCSRF tokens are generated per session. You can either add a hidden form field, or in the URL as query parameter.\r\n\r\n**Form**\r\n\r\n``` <input type=\"hidden\" name=\"csrf_token\" value=\"<?= Session::generateCsrfToken(); ?>\" /> ``` \r\n\r\n**URL**\r\n\r\n``` <a href=\"<?= PUBLIC_ROOT . \"?csrf_token=\" . urlencode(Session::generateCsrfToken()); ?>\">Link</a> ```\r\n\r\n**JavaScript**\r\n\r\nYou can also assign the CSRF token to a javascript variable. \r\n\r\n```<script>config = <?= json_encode(Session::generateCsrfToken()); ?>;</script>``` \r\n\r\n#### htacess<a name=\"htaccess\"></a>\r\n\r\n+ All requests will be redirected to ```index.php``` in public root folder. \r\n+ Block directory traversal/browsing\r\n+ Deny access to app directory(Althought it's not needed if you setup the application correctly)\r\n\r\n### Turn on/off Components(Middlewares) <a name=\"turn-on-off-components\"></a>\r\nSometimes you need to have a control on these components, such as when want to have a Controller without Authentication or Authorization, or a Security component is enabled. This can be done by override ```initialize()``` method inside your Controller class, and load only needed Components.\r\n\r\n**Example 1**: Don't load any component, no authentication or authorization, or security validations.\r\n```php\r\npublic function initialize(){\r\n\r\n\t$this->loadComponents([]);\r\n}\r\n```\r\n**Example 2**: Load Security, & Auth component, but don't authenticate and authorize, just in case you want to use the Auth component inside the action methods. [LoginController](https://github.com/OmarElGabry/miniPHP/blob/master/app/controllers/LoginController.php#L60) is an example on **how to access a page without require a logged-in user**.\r\n```php\r\npublic function initialize(){\r\n\t$this->loadComponents([ \r\n\t    \t'Auth',\r\n\t    \t'Security'\r\n\t    ]);\r\n}\r\n ```\r\n**Example 3**: Load Security, & Auth component, and authenticate user & authorize for the current controller. This is the default behavior in the [core/Controller](https://github.com/OmarElGabry/miniPHP/blob/master/app/core/Controller.php#L137) Class\r\n```php\r\npublic function initialize(){\r\n\t$this->loadComponents([\r\n\t\t'Auth' => [\r\n\t\t\t'authenticate' => ['User'],\r\n\t\t\t'authorize' => ['Controller']\r\n\t\t],\r\n\t\t'Security'\r\n\t    ]);\r\n}\r\n``` \r\n\r\n## Views <a name=\"views\"></a>\r\n\r\nInside the action method you can make a call to model to get some data, and/or render pages inside _views_ folder\r\n\r\n```php\r\n  //  NotesController\r\n  \r\n  public function index(){\r\n \r\n\t// render full page with layout(header and footer)\r\n\t$this->view->renderWithLayouts(Config::get('VIEWS_PATH') . \"layout/default/\", Config::get('VIEWS_PATH') . 'notes/index.php');\r\n\t\r\n\t// render page without layout\r\n\t$this->view->render(Config::get('VIEWS_PATH') . 'notes/note.php');\r\n\t\r\n\t// get the rendered page\r\n\t$html = $this->view->render(Config::get('VIEWS_PATH') . 'notes/note.php');\r\n\t\r\n\t// render a json view\r\n\t$this->view->renderJson(array(\"data\" => $html));\r\n  }\r\n```\r\n\r\n## Models <a name=\"models\"></a>\r\n> In MVC, the model represents the information (the data) and the business rules; the view contains elements of the user interface such as text, form inputs; and the controller manages the communication between the model and the view.\r\n[Source](http://www.yiiframework.com/doc/guide/1.1/en/basics.mvc)\r\n\r\nAll operations like create, delete, update, and validation are implemented in model classes.\r\n\r\n```php\r\n   // NotesController\r\n\r\n    public function create(){\r\n    \r\n\t\t// get content of note submitted to a form\r\n\t\t// then pass the content along with the current user to Note class\r\n\t\t$content  = $this->request->data(\"note_text\");\r\n\t\t$note     = $this->note->create(Session::getUserId(), $content);\r\n        \r\n        if(!$note){\r\n            $this->view->renderErrors($this->note->errors());\r\n        }else{\r\n            return $this->redirector->root(\"Notes\");\r\n        }\r\n    }\r\n```\r\n\r\n**In Notes Model**\r\n\r\n```php\r\n   // Notes Model\r\n\r\n    public function create($userId, $content){\r\n    \r\n    \t// using validation class(see below)\r\n        $validation = new Validation();\r\n        if(!$validation->validate(['Content'   => [$content, \"required|minLen(4)|maxLen(300)\"]])) {\r\n            $this->errors = $validation->errors();\r\n            return false;\r\n        }\r\n        \r\n        // using database class to insert new note\r\n        $database = Database::openConnection();\r\n        $query    = \"INSERT INTO notes (user_id, content) VALUES (:user_id, :content)\";\r\n        $database->prepare($query);\r\n        $database->bindValue(':user_id', $userId);\r\n        $database->bindValue(':content', $content);\r\n        $database->execute();\r\n        \r\n        if($database->countRows() !== 1){\r\n            throw new Exception(\"Couldn't create note\");\r\n        }\r\n        \r\n        return true;\r\n     }\r\n```\r\n\r\n## Login<a name=\"login\"></a>\r\nUsing the framework, you would probably do login, register, and logout. These actions are implemented in _app/models/Login_ & _app/controllers/LoginController_. In most situations, you won't need to modify anything related to login actions, just understand the behaviour of the framework. \r\n\r\n**NOTE** If you don't have SSL, you would better want to encrypt data manually at Client Side, If So, read [this](http://stackoverflow.com/questions/3715920/about-password-hashing-system-on-client-side) and also [this](http://stackoverflow.com/questions/4121629/password-encryption-at-client-side?lq=1).\r\n\r\n### User Verification<a name=\"user-verification\"></a>\r\nWhenever the user registers, An email will be sent with token concatenated with encrypted user id. This token will be expired after 24 hour. It's much better to expire these tokens, and re-use the registered email if they are expired.\r\n\r\n**Passwords** are hashed using the latest algorithms in PHP v5.5\r\n```php\r\n$hashedPassword = password_hash($password, PASSWORD_DEFAULT, array('cost' => Config::get('HASH_COST_FACTOR')));\r\n```\r\n\r\n### Forgotten Password<a name=\"forgotten-password\"></a>\r\nIf user forgot his password, he can restore it. The same idea of expired tokens goes here. \r\n\r\nIn addition, block user for certain duration(>= 10min) if he exceeded number of forgotten passwords attempts(5) during a certain duration(>= 10min).\r\n\r\n#### Brute Force Attack<a name=\"brute-force\"></a>\r\nThrottling brute-force attacks is when a hacker tries all possible input combination until he finds the correct password.\r\n\r\nSolution:\r\n+ Block failed logins, So, if a user exceeded number of failed logins(5) during certain duration(>= 10min), the email will be blocked for duration(>= 10min).\r\n+ Blocking will be for emails even these emails aren't stored in our database, meaning for non-registered users.\r\n+ Require **Strong** passwords\r\n\t- At least one lowercase character\r\n\t- At least one uppercase character\r\n\t- At least one special character\r\n\t- At least one number\r\n\t- Min Length is 8 characters\r\n\r\n### Captcha<a name=\"captcha\"></a>\r\nCAPTCHAs are particularly effective in preventing automated logins. Using [Captcha](https://github.com/Gregwar/Captcha) an awesome PHP Captcha library.\r\n\r\n### Block IP Address<a name=\"block-ip\"></a>\r\nBlocking IP Addresses is the last solution to think about. IP Address will be blocked if the same IP failed to login multiple times using different credentials(>=10).\r\n\r\n## Database<a name=\"database\"></a>\r\nPHP Data Objects (PDO) is used for preparing and executing database queries. Inside ```Database``` Class, there are various methods that hides complexity and let's you instantiate database object, prepare, bind, and execute in few lines.\r\n\r\n+ SQL Injection\r\n\t- Using prepared statements will prevent SQL Injection.\r\n+ Limit Privileges\r\n\t- Don't use _root_ user, Create a new one instead.\r\n\t- Always assign limited privileges to current database user\r\n\t- ```SELECT, INSERT, UPDATE, DELETE ``` are enough for users\r\n\t- For backups, It's recommended to use another database user with more privileges. These privileges needed for [mysqldump](https://dev.mysql.com/doc/refman/5.1/en/mysqldump.html) are mentioned in ```Admin``` Class.\r\n+ UTF-8\r\n\t- For complete UTF-8 support, you need to use ```utf8mb4 ```on database level.\r\n\t- MySQLâ€™s ```utf8``` charset only store UTF-8 encoded symbols that consist of one to three bytes. But, It can't for symbols with four bytes. \r\n\t- Here, charset is ```utf8```. But, if you want to upgrade to ```utf8mb4 ``` follow these links:\r\n\t\t- [Link 1](https://mathiasbynens.be/notes/mysql-utf8mb4) & [Link 2](https://dev.mysql.com/doc/refman/5.5/en/charset-unicode-upgrading.html)\r\n\t\t- Don't forget to change **charset** in _app/config/config.php_ to ```utf8mb4 ```\r\n\r\n## Encryption<a name=\"encryption\"></a>\r\n``` Encryption ``` Class is responsible for encrypting and decryption of data. Encryption is applied to things like cookies, User ID, Post ID, ..etc. Encrypted strings are authenticated and they are different every time you encrypt. \r\n\r\n## Validation<a name=\"validation\"></a>\r\nValidation is a small library for validating user inputs. All validation rules are inside ``` Validation ``` Class.\r\n\r\n#### Usage\r\n```php\r\n\r\n$validation = new Validation();\r\n\r\n// there are default error messages for each rule\r\n// but, you still can define your custom error message\r\n$validation->addRuleMessage(\"emailUnique\", \"The email you entered is already exists\");\r\n\r\nif(!$validation->validate([\r\n    \"User Name\" => [$name, \"required|alphaNumWithSpaces|minLen(4)|maxLen(30)\"],\r\n    \"Email\" => [$email, \"required|email|emailUnique|maxLen(50)\"],\r\n    'Password' => [$password,\"required|equals(\".$confirmPassword.\")|minLen(6)|password\"],\r\n    'Password Confirmation' => [$confirmPassword, 'required']])) {\r\n\r\n    var_dump($validation->errors());\r\n}\r\n```\r\n\r\n## Errors and Exceptions<a name=\"errors-exceptions\"></a>\r\n``` Handler``` Class is responsible for handling all exceptions and errors. It will use [Logger](#logger) to log errors. Error reporting is turned off by default, because every error will be logged and saved in  _app/logs/log.txt_.\r\n\r\nIf error encountered or exception was thrown, the application will show System Internal Error(500).\r\n\r\n### Configurations(php.ini)\r\n+ Turn Off display errors\r\n+ Turn Off log errors if not needed\r\n\r\n## Logger<a name=\"logger\"></a>\r\nA place where you can log anything and save it to _app/log/log.txt_. You can write any failures, errors, exceptions, or any other malicious actions or attacks.\r\n\r\n```php\r\nLogger::log(\"COOKIE\", self::$userId . \" is trying to login using invalid cookie\", __FILE__, __LINE__);\r\n```\r\n\r\n## Email<a name=\"email\"></a>\r\nEmails are sent using [PHPMailer](https://github.com/PHPMailer/PHPMailer) via SMTP, another library for sending emails. You shouldn't use ```mail()``` function of PHP.\r\n\r\n## Configurations<a name=\"configurations\"></a>\r\nIn _app/config_, there are two files, one called _config.php_ for main application configurations, and another one for javascript called _javascript.php_. The javascript configurations will be then assigned to a javascript variable in your _footer.php_.\r\n\r\n## JavaScript <a name=\"js\"></a>\r\nIn order to send request and recieve a respond, you may depend on Ajax calls to do so. This framework is heavily depends on ajax requests to perform actions, but, you still can do the same thing for normal requests with just small tweaks.\r\n\r\n#### In _public/main.js_\r\n\r\n**config** object is assigned to key-value pairs in [footer.php](https://github.com/OmarElGabry/miniPHP/blob/master/app/views/layout/default/footer.php). These key-value pairs can be added in server-side code using ```Config::setJsConfig('key', \"value\");```, which will be assigned then to _config_ object.\r\n\r\n**ajax** A namespace that has two main functions for sending ajax request. One for normal ajax calls, and another for for uploading files.\r\n\r\n**helpers** A namespace that has variety of functions display errors, serialize, redirect, encodeHTML, and so on\r\n\r\n**app** A namespace that's used to initalize the whole javascript events for the current page\r\n\r\n**events** A namespace that's used to declare all of events that may occure, like when user clicks on a link to create, delete or update.\r\n\r\n## Application(Demo) <a name=\"app-demo\"></a>\r\n### Intro<a name=\"intro-demo\"></a>\r\nIn order to show how to use the framework in a real-life situation, the framework comes with implementation for features like Manage User Profile Management, Dashbaord, News Feed, Upload & Download Files, Posts & Comments, Pagination, Admin panel, Manage System Backups, Notificatons, Report Bugs, ...etc.\r\n\r\n### Installation<a name=\"installation-demo\"></a>\r\nSteps:\r\n\r\n1. Edit configuration file in _app/config/config.php_ with your credentials\r\n\r\n2. Execute SQL queries in __installation_ directory in order\r\n\r\n3. Login\r\n\t+ Admin:\r\n\t\t+ Email: admin@demo.com\r\n\t\t+ Password: 12345\r\n\t+ Normal User:\r\n\t\t+ Email: user@demo.com\r\n\t\t+ Password: 12345\r\n\r\n**EMAIL SETUP** \r\n\r\nYou need to configure your SMTP account data in _app/config/config.php_. **But**, If you don't have SMTP account, then you save emails in _app/logs/log.txt_ using Logger. \r\n\r\nTo do that, In [core/Email](https://github.com/OmarElGabry/miniPHP/blob/master/app/core/Email.php#L78), comment ```$mail->Send()``` & uncomment ```Logger::log(\"EMAIL\", $mail->Body);``` \r\n\r\n### User Profile<a name=\"profile\"></a>\r\nEvery user can change his name, email, password. Also upload profile picture (i.e. initially assigned to default.png).\r\n\r\n#### Update & Revoke User Email<a name=\"update-revoke-user-email\"></a>\r\nWhenever user asks to change his email, a notification will be sent to user's old email, and the new one.\r\n\r\nThe notification sent to old email is giving the user the chance to revoke email change, while the notification sent to new email is asking for confirmation. User can still login with his old email until he confirms the change.\r\n\r\nThis is done in ```UserController```, In methods ```updateProfileInfo()```, ```revokeEmail()```, & ```updateEmail()```. In most situations, you won't need to modify the behavior of these methods.\r\n\r\n### Files<a name=\"files\"></a>\r\nYou can upload and download files.\r\n\r\n#### Upload\r\n+ All uploaded files are out of root public, so, they aren't accessible by anyone\r\n+ Validate against HTTP POST uploads, MIME, Size, Image dimension\r\n+ Setting file permission to avoid executable files\r\n+ Sanitizing file names\r\n+ Progress bar(no-plugins)\r\n\r\n#### Download\r\n+ Every file will have hashed version of it's name, this hashed name will be exposed to users. \r\n+ The hashed name = hash(original filename . extension). So, download link will look something like this: _http://miniPHP/downloads/download/b989f733f948e8a4b8b700e1_\r\n\r\n#### Configurations(php.ini)\r\n+ Set ```file_uploads``` to true\r\n+ Set ```upload_max_filesize, max_file_uploads, post_max_size```\r\n\t- Check [documentation](http://php.net/manual/en/ini.core.php#ini.post-max-size) to know how to assign proper values for each.\r\n\r\n### News Feeds, Posts & Comments <a name=\"newsfeed-posts-comments\"></a>\r\n\r\nThink of News Feed as tweets in twitter, and in Posts like when you open an Issue in Github.\r\n\r\nThey are implemented on the top of this framework. \r\n+ They are useful to show & apply some concepts like **Pagination**, \r\n+ How can you edit & delete in place(secured way), \r\n+ How can you manage permissions for who can create, edit, update and delete, and so forth.\r\n\r\n### Admin<a name=\"admin\"></a>\r\nAdmins can perform actions where normal users can't. They can delete, edit, create any newsfeed, post, or comment. Also they have control over all user profiles, create & restore backups.\r\n\r\n#### Users<a name=\"users\"></a>\r\nOnly admins have access to see all registered users. They can delete, edit their info.\r\n\r\n#### Backups<a name=\"backups\"></a>\r\nIn most of the situations, you will need to create backups for the system, and restore them whenever you want.\r\n\r\nThis is done by using [mysqldump](https://dev.mysql.com/doc/refman/5.1/en/mysqldump.html) to create and restore backups. All backups will be stored in _app/backups_.\r\n\r\n### Notifications<a name=\"notifications\"></a>\r\nDid you see the red notifications on facebook, or the blue one on twitter?. The same idea is here. But, It's implemented using triggers instead. Triggers are defined in __installation/triggers.sql_.\r\n\r\nSo, whenever user creates a new newsfeed, post, or upload a file, this will increment the count for all other users, and will display a red notification in navigation bar.\r\n\r\n### Report Bugs<a name=\"bugs\"></a>\r\nUsers can report Bugs, Features & Enhancements. Once they submitted the form, an email will be sent to ```ADMIN_EMAIL``` defined in _app/config/config.php_\r\n\r\n## ToDo Application<a name=\"todo\"></a>\r\nLet's say you want to build a simple ToDo Application. Here, I will go step by step on how to create a ToDo App using the framework with & without Ajax calls.\r\n\r\n(1) If you followed the installtion setup steps above, you shouldn't have any problem with creating initial user accounts.\r\n\r\n(2) Create a table with id as INT, content VARCHAR, user_id as Foreign Key to ```users``` table\r\n\r\n```sql\r\nCREATE TABLE `todo` (\r\n\t `id` int(11) NOT NULL AUTO_INCREMENT,\r\n\t `user_id` int(11) NOT NULL,\r\n\t `content` varchar(512) NOT NULL,\r\n\t PRIMARY KEY (`id`),\r\n\t FOREIGN KEY (`user_id`) REFERENCES `users` (`id`) ON DELETE CASCADE ON UPDATE CASCADE\r\n) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_general_ci;\r\n```\r\n\r\n(3) Create TodoController\r\n\r\nCreate a file called ```TodoController.php``` inside _app/controllers_\r\n\r\n```php\r\n\r\nclass TodoController extends Controller{\r\n\r\n    // override this method to perform any logic before calling action method as explained above\r\n    public function beforeAction(){\r\n\r\n        parent::beforeAction();\r\n\r\n        // define the actions in this Controller\r\n        $action = $this->request->param('action');\r\n\r\n        // restrict the request to action methods\r\n        // $this->Security->requireAjax(['create', 'delete']);\r\n        $this->Security->requirePost(['create', 'delete']);\r\n\r\n        // define the expected form fields for every action if exist\r\n        switch($action){\r\n            case \"create\":\r\n                // you can exclude form fields if you don't care if they were sent with form fields or not\r\n                $this->Security->config(\"form\", [ 'fields' => ['content']]);\r\n                break;\r\n            case \"delete\":\r\n\t\t\t\t// If you want to disable validation for form tampering\r\n\t\t\t\t// $this->Security->config(\"validateForm\", false);\r\n                $this->Security->config(\"form\", [ 'fields' => ['todo_id']]);\r\n                break;\r\n        }\r\n    }\r\n\r\n    public function index(){\r\n\r\n        $this->view->renderWithLayouts(Config::get('VIEWS_PATH') . \"layout/todo/\", Config::get('VIEWS_PATH') . 'todo/index.php');\r\n    }\r\n\r\n    public function create(){\r\n\r\n        $content  = $this->request->data(\"content\");\r\n        $todo     = $this->todo->create(Session::getUserId(), $content);\r\n\r\n        if(!$todo){\r\n\r\n            // in case of normal post request\r\n            Session::set('errors', $this->todo->errors());\r\n            return $this->redirector->root(\"Todo\");\r\n\r\n            // in case of ajax\r\n            // $this->view->renderErrors($this->todo->errors());\r\n\r\n        }else{\r\n\r\n            // in case of normal post request\r\n            Session::set('success', \"Todo has been created\");\r\n            return $this->redirector->root(\"Todo\");\r\n\r\n            // in case of ajax\r\n            // $this->view->renderJson(array(\"success\" => \"Todo has been created\"));\r\n        }\r\n    }\r\n\r\n    public function delete(){\r\n\r\n        $todoId = Encryption::decryptIdWithDash($this->request->data(\"todo_id\"));\r\n        $this->todo->delete($todoId);\r\n\r\n        // in case of normal post request\r\n        Session::set('success', \"Todo has been deleted\");\r\n        return $this->redirector->root(\"Todo\");\r\n\r\n        // in case of ajax\r\n        // $this->view->renderJson(array(\"success\" => \"Todo has been deleted\"));\r\n    }\r\n\r\n    public function isAuthorized(){\r\n\r\n        $action = $this->request->param('action');\r\n        $role = Session::getUserRole();\r\n        $resource = \"todo\";\r\n\r\n        // only for admins\r\n        Permission::allow('admin', $resource, ['*']);\r\n\r\n        // only for normal users\r\n        Permission::allow('user', $resource, ['delete'], 'owner');\r\n\r\n        $todoId = $this->request->data(\"todo_id\");\r\n\r\n        if(!empty($todoId)){\r\n            $todoId = Encryption::decryptIdWithDash($todoId);\r\n        }\r\n\r\n        $config = [\r\n            \"user_id\" => Session::getUserId(),\r\n            \"table\" => \"todo\",\r\n            \"id\" => $todoId];\r\n\r\n        return Permission::check($role, $resource, $action, $config);\r\n    }\r\n}\r\n```\r\n\r\n(4) Create Note Model Class called ```Todo.php``` in _app/models_\r\n\r\n```php\r\nclass Todo extends Model{\r\n\r\n    public function getAll(){\r\n\r\n        $database = Database::openConnection();\r\n        $query  = \"SELECT todo.id AS id, users.id AS user_id, users.name AS user_name, todo.content \";\r\n        $query .= \"FROM users, todo \";\r\n        $query .= \"WHERE users.id = todo.user_id \";\r\n\r\n        $database->prepare($query);\r\n        $database->execute();\r\n        $todo = $database->fetchAllAssociative();\r\n\r\n        return $todo;\r\n     }\r\n\r\n    public function create($userId, $content){\r\n    \r\n    \t// using validation class\r\n        $validation = new Validation();\r\n        if(!$validation->validate(['Content'   => [$content, \"required|minLen(4)|maxLen(300)\"]])) {\r\n            $this->errors = $validation->errors();\r\n            return false;\r\n        }\r\n        \r\n        // using database class to insert new todo\r\n        $database = Database::openConnection();\r\n        $query    = \"INSERT INTO todo (user_id, content) VALUES (:user_id, :content)\";\r\n        $database->prepare($query);\r\n        $database->bindValue(':user_id', $userId);\r\n        $database->bindValue(':content', $content);\r\n        $database->execute();\r\n        \r\n        if($database->countRows() !== 1){\r\n            throw new Exception(\"Couldn't create todo\");\r\n        }\r\n        \r\n        return true;\r\n     }\r\n  \r\n    public function delete($id){\r\n\r\n        $database = Database::openConnection();\r\n        $database->deleteById(\"todo\", $id);\r\n\r\n        if($database->countRows() !== 1){\r\n            throw new Exception (\"Couldn't delete todo\");\r\n        }\r\n    }\r\n }\r\n```\r\n\r\n(5) Inside _views/_\r\n\r\n(a) Create ```header.php``` & ```footer.php```  inside _views/layout/todo_\r\n\r\n```php\r\n<!DOCTYPE html>\r\n<html lang=\"en\">\r\n\r\n<head>\r\n\t\t\r\n    <meta charset=\"utf-8\">\r\n    <meta http-equiv=\"X-UA-Compatible\" content=\"IE=edge\">\r\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\">\r\n    <meta name=\"description\" content=\"mini PHP\">\r\n    <meta name=\"author\" content=\"mini PHP\">\r\n\r\n    <title>mini PHP</title>\r\n\r\n    <!-- Stylesheets -->\r\n    <link rel=\"stylesheet\" href=\"<?= PUBLIC_ROOT;?>css/bootstrap.min.css\">\r\n    <link rel=\"stylesheet\" href=\"<?= PUBLIC_ROOT;?>css/sb-admin-2.css\">\r\n    <link rel=\"stylesheet\" href=\"<?= PUBLIC_ROOT;?>css/font-awesome.min.css\" rel=\"stylesheet\" type=\"text/css\">\r\n\t\r\n    <!-- Styles for ToDo Application -->\r\n    <style>\r\n        .todo_container{\r\n            width:80%; \r\n            margin: 0 auto; \r\n            margin-top: 5%\r\n        }\r\n        #todo-list li{ \r\n            list-style-type: none; \r\n            border: 1px solid #e7e7e7;\r\n            padding: 3px;\r\n            margin: 3px;\r\n        }\r\n        #todo-list li:hover{\r\n            background-color: #eee;\r\n        }\r\n        form button{\r\n            float:right;\r\n            margin: 3px;\r\n        }\r\n        form:after{\r\n            content: '';\r\n            display: block;\r\n            clear: both;\r\n        }\r\n    </style>\r\n</head>\r\n<body>\r\n```\r\n\r\n```php\r\n\t<!-- footer -->\r\n\r\n\t<script src=\"http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js\"></script>\r\n\t<!--<script src=\"<?= PUBLIC_ROOT; ?>js/jquery.min.js\"></script>-->\r\n\t<script src=\"<?= PUBLIC_ROOT; ?>js/bootstrap.min.js\"></script>\r\n\t<script src=\"<?= PUBLIC_ROOT; ?>js/sb-admin-2.js\"></script>\r\n\t<script src=\"<?= PUBLIC_ROOT; ?>js/main.js\"></script>\r\n\r\n        <!-- Assign CSRF Token to JS variable -->\r\n\t\t<?php Config::setJsConfig('csrfToken', Session::generateCsrfToken()); ?>\r\n        <!-- Assign all configration variables -->\r\n\t\t<script>config = <?= json_encode(Config::getJsConfig()); ?>;</script>\r\n        <!-- Run the application -->\r\n        <script>$(document).ready(app.init());</script>\r\n        \r\n        <?php Database::closeConnection(); ?>\r\n\t</body>\r\n</html>\r\n```\r\n\r\n(b) Inside _views/_ Create todo folder that will have ```index.php```, which will contain our todo list. \r\n\r\n```php\r\n<div class=\"todo_container\">\r\n\r\n<h2>TODO Application</h2>\r\n\r\n<!-- in case of normal post request  -->\r\n<form action= \"<?= PUBLIC_ROOT . \"Todo/create\" ?>\"  method=\"post\">\r\n    <label>Content <span class=\"text-danger\">*</span></label>\r\n    <textarea name=\"content\" class=\"form-control\" required placeholder=\"What are you thinking?\"></textarea>\r\n    <input type='hidden' name = \"csrf_token\" value = \"<?= Session::generateCsrfToken(); ?>\">\r\n    <button type=\"submit\" name=\"submit\" value=\"submit\" class=\"btn btn-success\">Create</button>\r\n</form>\r\n\r\n\r\n<!-- in case of ajax request  \r\n<form action= \"#\" id=\"form-create-todo\" method=\"post\">\r\n    <label>Content <span class=\"text-danger\">*</span></label>\r\n    <textarea name=\"content\" class=\"form-control\" required placeholder=\"What are you thinking?\"></textarea>\r\n    <button type=\"submit\" name=\"submit\" value=\"submit\" class=\"btn btn-success\">Create</button>\r\n</form>\r\n-->\r\n\r\n<br>\r\n<?php \r\n\r\n// display success or error messages in session\r\nif(!empty(Session::get('success'))){\r\n    echo $this->renderSuccess(Session::getAndDestroy('success'));\r\n}else if(!empty(Session::get('errors'))){\r\n    echo $this->renderErrors(Session::getAndDestroy('errors'));\r\n}\r\n\r\n?>\r\n\r\n<br><hr><br>\r\n\r\n<ul id=\"todo-list\">\r\n<?php \r\n    $todoData = $this->controller->todo->getAll();\r\n    foreach($todoData as $todo){ \r\n?>\r\n        <li>\r\n            <p> <?= $this->autoLinks($this->encodeHTMLWithBR($todo[\"content\"])); ?></p>\r\n\r\n            <!-- in case of normal post request -->\r\n            <form action= \"<?= PUBLIC_ROOT . \"Todo/delete\" ?>\" method=\"post\">\r\n                <input type='hidden' name= \"todo_id\" value=\"<?= \"todo-\" . Encryption::encryptId($todo[\"id\"]);?>\">\r\n                <input type='hidden' name = \"csrf_token\" value = \"<?= Session::generateCsrfToken(); ?>\">\r\n                <button type=\"submit\" name=\"submit\" value=\"submit\" class=\"btn btn-xs btn-danger\">Delete</button>\r\n            </form>\r\n\r\n\r\n            <!-- in case of ajax request \r\n            <form class=\"form-delete-todo\" action= \"#\"  method=\"post\">\r\n                <input type='hidden' name= \"todo_id\" value=\"<?= \"todo-\" . Encryption::encryptId($todo[\"id\"]);?>\">\r\n                <button type=\"submit\" name=\"submit\" value=\"submit\" class=\"btn btn-xs btn-danger\">Delete</button>\r\n            </form>\r\n             -->\r\n        </li>\r\n    <?php } ?>\r\n</ul>\r\n\r\n</div>\r\n```\r\n\r\n(6) JavaScript code to send ajax calls, and handle respond\r\n\r\n```js\r\n\r\n// first, we need to initialize the todo events whenever the application initalized\r\n// the app.init() is called in footer.php, see views/layout/todo/footer.php\r\n\r\nvar app = {\r\n    init: function (){\r\n    \r\n    \tevents.todo.init();\r\n    }\r\n};\r\n\r\n// inside var events = {....} make a new key called \"todo\" \r\nvar events = {\r\n\t// ....\r\n\ttodo:{\r\n\t        init: function(){\r\n\t            events.todo.create();\r\n\t            events.todo.delete();\r\n\t        },\r\n\t        create: function(){\r\n\t            $(\"#form-create-todo\").submit(function(e){\r\n\t                e.preventDefault();\r\n\t                ajax.send(\"Todo/create\", helpers.serialize(this), createTodoCallBack, \"#form-create-todo\");\r\n\t            });\r\n\t\r\n\t            function createTodoCallBack(PHPData){\r\n\t                if(helpers.validateData(PHPData, \"#form-create-todo\", \"after\", \"default\", \"success\")){\r\n\t                    alert(PHPData.success + \" refresh the page to see the results\");\r\n\t                }\r\n\t            }\r\n\t        },\r\n\t        delete: function(){\r\n\t            $(\"#todo-list form.form-delete-todo\").submit(function(e){\r\n\t                e.preventDefault();\r\n\t                if (!confirm(\"Are you sure?\")) { return; }\r\n\t                \r\n\t                var cur_todo = $(this).parent();\r\n\t                ajax.send(\"Todo/delete\", helpers.serialize(this), deleteTodoCallBack, cur_todo);\r\n\t                \r\n\t                function deleteTodoCallBack(PHPData){\r\n\t                    if(helpers.validateData(PHPData, cur_todo, \"after\", \"default\", \"success\")){\r\n\t                        $(cur_todo).remove();\r\n\t                        alert(PHPData.success);\r\n\t                    }\r\n\t                }\r\n\t            });\r\n\t\t}\r\n\t}\r\n}\r\n```\r\n\r\n### Support <a name=\"support\"></a>\r\nI've written this script in my free time during my studies. This is for free, unpaid. I am saying this because I've seen many developers acts very rude towards any software, and their behavior is really frustrating. I don't know why?! Everyone tends to complain, and saying harsh words. I do accept the feedback, but, in a good and respectful manner.\r\n\r\nThere are many other scripts online for purchase that does the same thing(if not less), and their authors are earning good money from it, but, I choose to keep it public, available for everyone.\r\n\r\nIf you learnt something, or I saved your time, please support the project by spreading the word.\r\n\r\n### Contribute <a name=\"contribute\"></a>\r\n\r\nContribute by creating new issues, sending pull requests on Github or you can send an email at: omar.elgabry.93@gmail.com\r\n\r\n### Dependencies <a name=\"dependencies\"></a>\r\n+ [PHPMailer](https://github.com/PHPMailer/PHPMailer)\r\n+ [Captcha](https://github.com/Gregwar/Captcha)\r\n+ [Theme SB Admin 2](https://github.com/IronSummitMedia/startbootstrap-sb-admin-2)\r\n\r\n### License <a name=\"license\"></a>\r\nBuilt under [MIT](http://www.opensource.org/licenses/mit-license.php) license.\r\n",
  "note": "Don't delete this file! It's used internally to help with page regeneration."
}